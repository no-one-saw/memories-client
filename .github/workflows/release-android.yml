name: Release Android APK

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-android
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.4
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Determine next tag
        id: tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          latest=$(gh api repos/${{ github.repository }}/releases/latest --jq .tag_name 2>/dev/null || echo "")
          if [[ -z "$latest" ]]; then
            next="v1"
          else
            n=${latest#v}
            if ! [[ "$n" =~ ^[0-9]+$ ]]; then
              echo "Latest tag is not v<integer>: $latest" >&2
              exit 1
            fi
            next="v$((n+1))"
          fi
          echo "next=$next" >> $GITHUB_OUTPUT

      - name: Patch app.json releaseTag
        run: |
          node -e "const fs=require('fs'); const p='app.json'; const j=JSON.parse(fs.readFileSync(p,'utf8')); j.expo=j.expo||{}; j.expo.extra=j.expo.extra||{}; j.expo.extra.RELEASE_TAG='${{ steps.tag.outputs.next }}'; fs.writeFileSync(p, JSON.stringify(j, null, 2) + '\n');"

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EAS_TOKEN }}

      - name: EAS Build (APK)
        id: eas
        run: |
          set -euo pipefail
          eas build --platform android --profile production --non-interactive --json > eas-build.json
          cat eas-build.json

      - name: Download APK artifact
        id: dl
        run: |
          set -euo pipefail
          url=$(node -e "const j=require('./eas-build.json'); const b=Array.isArray(j)?j[0]:j; console.log(b.artifacts && b.artifacts.buildUrl ? b.artifacts.buildUrl : (b.buildUrl||''));")
          if [[ -z "$url" ]]; then
            echo "Could not find build artifact URL in eas-build.json" >&2
            exit 1
          fi
          echo "artifact_url=$url" >> $GITHUB_OUTPUT
          curl -L --fail --output app-${{ steps.tag.outputs.next }}.apk "$url"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ steps.tag.outputs.next }}"
          gh release create "$tag" --title "$tag" --notes "Automated release $tag" --target "${{ github.sha }}"
          gh release upload "$tag" "app-${{ steps.tag.outputs.next }}.apk" --clobber
